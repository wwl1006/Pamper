<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.work.pamper.mapper.ServiceApplicationMapper">

    <insert id="createApplication" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO service_application (service_id, user_id, pet_id, message, contact,
                                        status, create_time, update_time)
        VALUES (#{service_id}, #{user_id}, #{pet_id}, #{message}, #{contact},
                #{status}, #{create_time}, #{update_time})
    </insert>

    <select id="getApplicationById" resultType="com.work.pamper.entity.ServiceApplication">
        SELECT sa.*,
               a.username,
               a.id as avatar,
               pp.pet_name,
               si.title as service_title
        FROM service_application sa
        LEFT JOIN account a ON sa.user_id = a.id
        LEFT JOIN pet_profile pp ON sa.pet_id = pp.id
        LEFT JOIN service_info si ON sa.service_id = si.id
        WHERE sa.id = #{id}
    </select>

    <select id="getApplicationsByServiceId" resultType="com.work.pamper.entity.ServiceApplication">
        SELECT sa.*,
               a.username,
               a.id as avatar,
               pp.pet_name
        FROM service_application sa
        LEFT JOIN account a ON sa.user_id = a.id
        LEFT JOIN pet_profile pp ON sa.pet_id = pp.id
        WHERE sa.service_id = #{serviceId}
        ORDER BY sa.create_time DESC
    </select>

    <select id="getApplicationsByUserId" resultType="com.work.pamper.entity.ServiceApplication">
        SELECT sa.*,
               si.title as service_title,
               si.service_type,
               pp.pet_name
        FROM service_application sa
        LEFT JOIN service_info si ON sa.service_id = si.id
        LEFT JOIN pet_profile pp ON sa.pet_id = pp.id
        WHERE sa.user_id = #{userId}
        ORDER BY sa.create_time DESC
    </select>

    <select id="checkUserApplied" resultType="int">
        SELECT COUNT(*)
        FROM service_application
        WHERE service_id = #{serviceId}
          AND user_id = #{userId}
          AND status != 3
    </select>

    <update id="updateApplicationStatus">
        UPDATE service_application
        SET status = #{status},
            reply = #{reply},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <delete id="deleteApplication">
        DELETE FROM service_application WHERE id = #{id}
    </delete>
</mapper>
