<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.work.pamper.mapper.ActivityMapper">

    <insert id="createActivity" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO activity (title, content, cover_image, images, activity_type, location,
                             start_time, end_time, registration_deadline, max_participants,
                             current_participants, organizer, contact, status, view_count,
                             create_by, create_time, update_time)
        VALUES (#{title}, #{content}, #{cover_image}, #{images}, #{activity_type}, #{location},
                #{start_time}, #{end_time}, #{registration_deadline}, #{max_participants},
                #{current_participants}, #{organizer}, #{contact}, #{status}, #{view_count},
                #{create_by}, #{create_time}, #{update_time})
    </insert>

    <select id="getActivityById" resultType="com.work.pamper.entity.Activity">
        SELECT a.*,
               acc.username as creator_name,
               CASE WHEN ar.id IS NOT NULL THEN 1 ELSE 0 END as is_registered,
               CASE WHEN a.max_participants > 0 AND a.current_participants >= a.max_participants THEN 1 ELSE 0 END as is_full
        FROM activity a
        LEFT JOIN account acc ON a.create_by = acc.id
        LEFT JOIN activity_registration ar ON a.id = ar.activity_id AND ar.user_id = #{userId} AND ar.status = 1
        WHERE a.id = #{id}
    </select>

    <select id="getActivityList" resultType="com.work.pamper.entity.Activity">
        SELECT a.*,
               acc.username as creator_name,
               CASE WHEN ar.id IS NOT NULL THEN 1 ELSE 0 END as is_registered,
               CASE WHEN a.max_participants > 0 AND a.current_participants >= a.max_participants THEN 1 ELSE 0 END as is_full
        FROM activity a
        LEFT JOIN account acc ON a.create_by = acc.id
        LEFT JOIN activity_registration ar ON a.id = ar.activity_id AND ar.user_id = #{userId} AND ar.status = 1
        WHERE 1=1
        <if test="status != null">
            AND a.status = #{status}
        </if>
        <if test="activityType != null and activityType != ''">
            AND a.activity_type = #{activityType}
        </if>
        ORDER BY a.start_time DESC, a.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="getActivityCount" resultType="int">
        SELECT COUNT(*)
        FROM activity
        WHERE 1=1
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="activityType != null and activityType != ''">
            AND activity_type = #{activityType}
        </if>
    </select>

    <select id="getActivitiesByCreator" resultType="com.work.pamper.entity.Activity">
        SELECT * FROM activity
        WHERE create_by = #{createBy}
        ORDER BY create_time DESC
    </select>

    <update id="updateActivity">
        UPDATE activity
        SET title = #{title},
            content = #{content},
            cover_image = #{cover_image},
            images = #{images},
            activity_type = #{activity_type},
            location = #{location},
            start_time = #{start_time},
            end_time = #{end_time},
            registration_deadline = #{registration_deadline},
            max_participants = #{max_participants},
            organizer = #{organizer},
            contact = #{contact},
            update_time = #{update_time}
        WHERE id = #{id}
    </update>

    <delete id="deleteActivity">
        DELETE FROM activity WHERE id = #{id}
    </delete>

    <update id="updateActivityStatus">
        UPDATE activity
        SET status = #{status}
        WHERE id = #{id}
    </update>

    <update id="increaseViewCount">
        UPDATE activity
        SET view_count = view_count + 1
        WHERE id = #{id}
    </update>

    <update id="increaseParticipants">
        UPDATE activity
        SET current_participants = current_participants + 1
        WHERE id = #{id}
    </update>

    <update id="decreaseParticipants">
        UPDATE activity
        SET current_participants = current_participants - 1
        WHERE id = #{id} AND current_participants > 0
    </update>

    <!-- 管理员功能 -->
    <select id="getActivitiesByStatus" resultType="map">
        SELECT a.id, a.title, a.activity_type, a.location, a.start_time, a.end_time,
               a.max_participants, a.current_participants, a.status, a.create_time,
               acc.username as creator_name
        FROM activity a
        LEFT JOIN account acc ON a.create_by = acc.id
        WHERE a.status = #{status}
        ORDER BY a.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="getActivityCountByType" resultType="map">
        SELECT activity_type AS name, COUNT(*) AS value
        FROM activity
        WHERE status = 1
        GROUP BY activity_type
    </select>

    <select id="getTotalRegistrationCount" resultType="int">
        SELECT COUNT(*) FROM activity_registration WHERE status = 1
    </select>

    <select id="getAllActivitiesForAdmin" resultType="map">
        SELECT a.id, a.title, a.activity_type, a.location, a.start_time, a.end_time,
               a.max_participants, a.current_participants, a.status, a.create_time,
               acc.username as creator_name
        FROM activity a
        LEFT JOIN account acc ON a.create_by = acc.id
        ORDER BY a.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countAllActivities" resultType="int">
        SELECT COUNT(*) FROM activity
    </select>
</mapper>
